name: Build Gocron ARM64 (Full Version)

on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 下载 gocron 源码
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: 'ouqiang/gocron'
          ref: 'master'

      # 2. 设置 Node.js 环境 (编译前端需要)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 12 # gocron 旧版本前端需要较低版本的 node

      # 3. 编译前端 Vue 项目
      - name: Build Frontend
        run: |
          cd web/vue
          npm install
          npm run build
          cd ../..

      # 4. 设置 Go 环境
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # 5. 安装 statik (用于将网页打包进二进制文件)
      - name: Install Statik
        run: go install github.com/rakyll/statik@latest

      # 6. 生成静态资源并编译 ARM64 二进制
      - name: Build Binary
        run: |
          export GOOS=linux
          export GOARCH=arm64
          export CGO_ENABLED=0
          export PATH=$PATH:$(go env GOPATH)/bin

          # 生成静态资源代码
          statik -src=web/public -dest=internal -p=statik -f

          # 编译主程序 (管理后台)
          go build -ldflags "-s -w" -o gocron-linux-arm64 .

          # 编译节点程序 (执行器)
          cd node
          go build -ldflags "-s -w" -o gocron-node-linux-arm64 .
          cd ..

      # 7. 打包并上传
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gocron-arm64-full
          path: |
            gocron-linux-arm64
            node/gocron-node-linux-arm64
