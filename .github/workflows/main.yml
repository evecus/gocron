name: Build Gocron ARM64 Final

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 克隆源码
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: 'ouqiang/gocron'
          ref: 'master'

      # 2. 设置 Node.js 12
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 12

      # 3. 编译前端 (绕过 Lint)
      - name: Build Frontend
        run: |
          cd web/vue
          # 【关键修正】将 eslint-loader 替换为 babel-loader
          # 这样既保持了 Webpack 配置对象的完整性，又跳过了该死的代码检查
          sed -i 's/eslint-loader/babel-loader/g' build/webpack.base.conf.js
          
          npm install
          npm run build
          cd ../..

      # 4. 设置 Go 环境
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # 5. 安装并运行 statik
      - name: Install Statik
        run: go install github.com/rakyll/statik@latest

      # 6. 打包并编译二进制
      - name: Build Binary
        run: |
          export GOOS=linux
          export GOARCH=arm64
          export CGO_ENABLED=0
          export PATH=$PATH:$(go env GOPATH)/bin

          # 生成静态资源代码 (将 web/public 目录打包)
          statik -src=web/public -dest=internal -p=statik -f

          # 编译管理后台
          go build -ldflags "-s -w" -o gocron-linux-arm64 .

          # 编译执行节点
          cd node
          go build -ldflags "-s -w" -o gocron-node-linux-arm64 .
          cd ..

      # 7. 上传
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gocron-arm64-success
          path: |
            gocron-linux-arm64
            node/gocron-node-linux-arm64
