name: Build Gocron ARM64

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 克隆源码到当前根目录
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: 'ouqiang/gocron'
          ref: 'master'
          path: '.' # 确保源码就在当前工作目录，防止找不到 Go 文件

      # 2. 设置 Node.js 12 (旧项目必须用老版本 Node)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 12

      # 3. 强制禁用 ESLint 并编译前端
      - name: Build Frontend
        run: |
          cd web/vue
          # 【关键步骤】删除所有关于 eslint 的配置，防止编译报错
          sed -i '/eslint-loader/d' build/webpack.base.conf.js
          
          npm install
          # 忽略所有的 lint 错误，只管编译
          npm run build
          cd ../..

      # 4. 设置 Go 环境
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # 5. 安装 statik 静态资源打包工具
      - name: Install Statik
        run: go install github.com/rakyll/statik@latest

      # 6. 打包静态资源并编译二进制
      - name: Build Binary
        run: |
          export GOOS=linux
          export GOARCH=arm64
          export CGO_ENABLED=0
          # 将 go bin 添加到路径
          export PATH=$PATH:$(go env GOPATH)/bin

          # 将前端生成的静态文件转为 Go 代码
          # 确保 web/public 目录下已经有了 npm run build 生成的文件
          statik -src=web/public -dest=internal -p=statik -f

          # 编译主程序 (管理后台)
          go build -ldflags "-s -w" -o gocron-linux-arm64 .

          # 编译执行节点
          cd node
          go build -ldflags "-s -w" -o gocron-node-linux-arm64 .
          cd ..

      # 7. 上传编译好的文件
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gocron-arm64-fixed
          path: |
            gocron-linux-arm64
            node/gocron-node-linux-arm64
